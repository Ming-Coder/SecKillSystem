# 2018-08
## 10000并发量测试
  > 测试脚本环境：E3-1230 v5 @ 3.40GHz X4  8G RAM  
  > 项目运行环境：i5-4200m X1 8G RAM

|并发控制|Avg|Min|Max|
|:-----:|:-:|:-:|:-:|
|悲观锁(未使用缓存)X1|5733|11|16961
|悲观锁(未使用缓存)X2|6044|10|17806
|悲观锁(未使用缓存)X3|6593|10|19206
|乐观锁(未使用缓存)X1|3176|5|11399
|乐观锁(未使用缓存)X2|2594|6|9521
|乐观锁(未使用缓存)X3|5312|7|13707
|乐观锁(使用Redis缓存)X1|96|6|1322
|乐观锁(使用Redis缓存)X2|111|5|2336
|乐观锁(使用Redis缓存)X3|736|7|3545

## 悲观锁结果
![悲观锁](imgs/pessiX1.png)

## 乐观锁结果  
![乐观锁](imgs/optiX1.png)

## 乐观锁&&缓存结果  
![乐观锁&&缓存](imgs/optiCacheX2.png)
  
# 2019-06 
## 100000并发量测试 
  > 测试脚本环境：Intel(R) Core(TM) i7-6800K CPU @ 3.40GHz X4  16G RAM  
  > 项目运行环境：Intel(R) Xeon(R) CPU E3-1230 v5 @ 3.40GHz X4 8G RAM
  
## 问题记录
### 1.MySQL异常
> `ERROR 1040 (HY000): Too many connections`，获取不到可用的连接，远程登录不上MySQL。原因是MySQL最大连接数量有限制，默认是151。

解决方案：修改MySQL最大连接数量

### 2.在DB层面使用乐观锁保证线程安全以后，仍然会出现超卖问题
> 由于用到了消息队列，刚开始以为是消息队列消费端的问题，不过在消费端已经做了幂等性处理。  
输出的异常日志中出现了NullPointerException，是在消息入队后抛出的，此时就会事务就会回滚，但是消息不是事务的，消息已经放到消息队列中所以会出现超卖问题  
抛出异常是因为，我随机生成的测试数据中有的userId数据库中没有，又因为当将消息添加到消息队列以后，还需要将用户针对这件商品的购买记录添加到缓存中，在执行user.getUserId()时抛出了NPE

解决方案：在执行入队之前，先判断User是否为空，如果为空直接抛异常，消息不入队。否则正常入队。
---

### 3.TODO: " ROCKETMQ [TIMEOUT_CLEAN_QUEUE]broker busy "